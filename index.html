<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viticultor Pro | Monitorizare Recoltă</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary: #5E2B7A;
            --primary-light: #8E4DA8;
            --primary-dark: #3D1C50;
            --secondary: #D4A76A;
            --secondary-light: #E8C9A0;
            --secondary-dark: #B08C4E;
            --accent: #8BC34A;
            --accent-light: #A5D76E;
            --accent-dark: #6B9F37;
            --dark: #2C2C2C;
            --light: #F9F5FC;
            --text: #4A4A4A;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --info: #2196F3;
            --shadow: 0 8px 24px rgba(0,0,0,0.08);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary: #9C6FB6;
            --primary-light: #B58FD1;
            --primary-dark: #7D4F9B;
            --secondary: #E8C9A0;
            --secondary-light: #F2DEC6;
            --secondary-dark: #D4A76A;
            --accent: #A5D76E;
            --accent-light: #C1E39B;
            --accent-dark: #8BC34A;
            --dark: #E0E0E0;
            --light: #121212;
            --text: #F0F0F0;
            --bg-color: #121212;
            --card-bg: #1A1A1A;
            --border-color: #444;
            --input-bg: #1E1E1E;
            --input-border: #555;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: var(--transition);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
        }

        /* Login Form Styles */
        .login-container {
            max-width: 500px;
            margin: 5rem auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius);
            background: var(--input-bg);
            color: var(--text);
            font-size: 1rem;
        }

        .input-field:focus {
            outline: 2px solid var(--primary);
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .admin-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        /* Admin Panel Styles */
        .admin-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .search-bar {
            width: 100%;
            padding: 1rem;
            margin-bottom: 2rem;
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius);
            background: var(--input-bg);
            color: var(--text);
        }

        .admin-section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .user-list, .winery-list {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .user-item, .winery-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .admin-actions {
            display: flex;
            gap: 0.5rem;
        }

        .admin-btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .edit-btn {
            background: var(--accent);
            color: white;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        /* Winery Selection */
        .winery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .winery-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .winery-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .winery-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .winery-card-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--primary);
            font-weight: 600;
        }

        .winery-card-code {
            background: var(--light);
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Monitoring Dashboard */
        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .winery-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .variety-select {
            margin-bottom: 1.5rem;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .parameter-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 1.2rem;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }

        .parameter-card.warning {
            border-left-color: var(--warning);
            background-color: rgba(255, 152, 0, 0.05);
        }

        .parameter-card.danger {
            border-left-color: var(--danger);
            background-color: rgba(244, 67, 54, 0.05);
        }

        .parameter-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .parameter-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parameter-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success);
        }

        .parameter-status.warning {
            background-color: var(--warning);
        }

        .parameter-status.danger {
            background-color: var(--danger);
        }

        .parameter-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--primary);
        }

        .parameter-range {
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.8;
        }

        .warning-box {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--danger);
            border-radius: 4px;
            padding: 1rem;
            margin: 1.5rem 0;
            animation: fadeIn 0.5s ease;
        }

        .chart-container {
            height: 300px;
            margin-top: 2rem;
        }

        .timeframe-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .timeframe-btn {
            padding: 0.5rem 1rem;
            background: var(--light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .timeframe-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Chat Widget */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chat-box {
            width: 350px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: none;
            flex-direction: column;
            max-height: 500px;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 400px;
        }

        .message {
            max-width: 80%;
            padding: 0.8rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }

        .user-message {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .ai-message {
            background: var(--light);
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
            }
            
            .parameters-grid {
                grid-template-columns: 1fr;
            }
            
            .winery-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-box {
                width: 300px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
        </svg>
    </button>

    <div class="app-container">
        <!-- Login Form -->
        <div class="login-container" id="login-container">
            <div class="login-header">
                <h1>Viticultor Pro</h1>
                <p>Monitorizare avansată a viței de vie</p>
            </div>
            <div class="input-group">
                <input type="text" class="input-field" id="username" placeholder="Username" required>
            </div>
            <div class="input-group">
                <input type="password" class="input-field" id="password" placeholder="Parolă" required>
            </div>
            <button class="submit-btn" id="login-btn">Autentificare</button>
            <a class="admin-link" id="admin-login-link">Acces administrator</a>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel" id="admin-panel">
            <h2>Panou Administrare</h2>
            <input type="text" class="search-bar" id="admin-search" placeholder="Caută...">
            
            <div class="admin-section">
                <div class="section-header">
                    <h3>Utilizatori</h3>
                    <button class="admin-btn edit-btn" id="add-user-btn">Adaugă utilizator</button>
                </div>
                <div class="user-list" id="user-list"></div>
            </div>
            
            <div class="admin-section">
                <div class="section-header">
                    <h3>Recolte</h3>
                    <button class="admin-btn edit-btn" id="add-winery-btn">Adaugă recoltă</button>
                </div>
                <div class="winery-list" id="winery-list"></div>
            </div>
            
            <button class="submit-btn" style="background: var(--danger); margin-top: 2rem;" id="admin-logout-btn">Deconectare</button>
        </div>

        <!-- Winery Selection -->
        <div class="winery-grid" id="winery-grid">
            <h2>Selectați o recoltă</h2>
            <div id="winery-cards-container"></div>
            <button class="submit-btn" id="add-winery-user-btn">Adaugă recoltă nouă</button>
        </div>

        <!-- Monitoring Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="card">
                <h2 class="winery-name" id="current-winery-name"></h2>
                
                <div class="variety-select">
                    <label for="variety-select">Selectați soiul:</label>
                    <select id="variety-select" class="input-field"></select>
                </div>
                
                <div class="parameters-grid" id="parameters-grid"></div>
                
                <div id="warning-box" class="warning-box" style="display: none;">
                    <h3>Atenție: Probleme detectate</h3>
                    <div id="warning-message"></div>
                </div>
                
                <div class="chart-container">
                    <canvas id="harvest-chart"></canvas>
                </div>
                
                <div class="timeframe-selector">
                    <button class="timeframe-btn active" data-timeframe="7">7 zile</button>
                    <button class="timeframe-btn" data-timeframe="30">30 zile</button>
                    <button class="timeframe-btn" data-timeframe="90">90 zile</button>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="submit-btn" id="live-camera-btn">Vizualizare live</button>
                    <button class="submit-btn" id="open-chat-btn">Chat cu specialist</button>
                    <button class="submit-btn" style="background: var(--secondary);" id="back-to-wineries-btn">Înapoi la recolte</button>
                </div>
            </div>
        </div>

        <!-- Live Camera Modal -->
        <div class="modal" id="camera-modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Vizualizare live</h2>
                    <button class="close-modal" id="close-camera-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div style="background: #000; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <img src="https://via.placeholder.com/800x450?text=Camera+Live" alt="Camera live" style="width: 100%; border-radius: 4px;">
                </div>
                <button class="submit-btn" id="refresh-camera-btn">Reîmprospătare imagine</button>
            </div>
        </div>

        <!-- Add Winery Modal -->
        <div class="modal" id="add-winery-modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Adaugă recoltă</h2>
                    <button class="close-modal" id="close-add-winery-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="input-group">
                    <label for="winery-code">Cod recoltă:</label>
                    <input type="text" id="winery-code" class="input-field" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="submit-btn" id="confirm-add-winery">Confirmă</button>
                    <button class="submit-btn" style="background: var(--danger);" id="cancel-add-winery">Anulează</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal" id="confirm-modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 id="confirm-title">Confirmați acțiunea</h2>
                    <button class="close-modal" id="close-confirm-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <p id="confirm-message">Sunteți sigur că doriți să continuați?</p>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="submit-btn" id="confirm-action">Da</button>
                    <button class="submit-btn" style="background: var(--danger);" id="cancel-action">Nu</button>
                </div>
            </div>
        </div>

        <!-- Chat Widget -->
        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai-message">Bună ziua! Sunt asistentul dumneavoastră viticol. Cu ce vă pot ajuta astăzi?</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Scrie mesajul tău...">
                    <button class="submit-btn" id="send-btn">Trimite</button>
                </div>
            </div>
            <button class="submit-btn" id="chat-toggle-btn" style="width: 60px; height: 60px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obiectul principal al aplicației
            const app = {
                // Datele aplicației
                users: [
                    { id: 1, username: "user1", password: "pass1", wineries: [1, 2] },
                    { id: 2, username: "user2", password: "pass2", wineries: [3] }
                ],
                admin: { username: "admin", password: "admin123" },
                wineries: [
                    { 
                        id: 1, 
                        code: "VIN001", 
                        name: "Recolta Dealul Mare", 
                        location: "Dealul Mare", 
                        area: 5.2, 
                        varieties: ["Merlot", "Cabernet Sauvignon"],
                        data: {
                            sugar: "24.5",
                            acidity: "6.2",
                            ph: "3.5",
                            temperature: "22.5",
                            humidity: "65",
                            soil: "Optim"
                        }
                    },
                    { 
                        id: 2, 
                        code: "VIN002", 
                        name: "Livezi Murfatlar", 
                        location: "Murfatlar", 
                        area: 8.7, 
                        varieties: ["Chardonnay", "Pinot Noir"],
                        data: {
                            sugar: "23.8",
                            acidity: "5.8",
                            ph: "3.4",
                            temperature: "24.2",
                            humidity: "58",
                            soil: "Umed"
                        }
                    },
                    { 
                        id: 3, 
                        code: "VIN003", 
                        name: "Domeniul Cotnari", 
                        location: "Cotnari", 
                        area: 12.3, 
                        varieties: ["Fetească Albă", "Fetească Regală"],
                        data: {
                            sugar: "22.1",
                            acidity: "6.5",
                            ph: "3.6",
                            temperature: "21.8",
                            humidity: "72",
                            soil: "Optim"
                        }
                    }
                ],
                currentUser: null,
                currentWinery: null,
                chart: null,
                chatHistory: [],
                isAdmin: false,

                // Inițializare aplicație
                init() {
                    this.loadFromLocalStorage();
                    this.initElements();
                    this.bindEvents();
                    this.checkDarkMode();
                    this.showLogin();
                },

                // Încărcare date din localStorage
                loadFromLocalStorage() {
                    const savedUsers = localStorage.getItem('vineyardUsers');
                    const savedWineries = localStorage.getItem('vineyardWineries');
                    const savedChat = localStorage.getItem('vineyardChatHistory');
                    
                    if (savedUsers) this.users = JSON.parse(savedUsers);
                    if (savedWineries) this.wineries = JSON.parse(savedWineries);
                    if (savedChat) this.chatHistory = JSON.parse(savedChat);
                },

                // Salvare date în localStorage
                saveToLocalStorage() {
                    localStorage.setItem('vineyardUsers', JSON.stringify(this.users));
                    localStorage.setItem('vineyardWineries', JSON.stringify(this.wineries));
                    localStorage.setItem('vineyardChatHistory', JSON.stringify(this.chatHistory));
                },

                // Inițializare elemente DOM
                initElements() {
                    this.elements = {
                        // Login
                        loginContainer: document.getElementById('login-container'),
                        usernameInput: document.getElementById('username'),
                        passwordInput: document.getElementById('password'),
                        loginBtn: document.getElementById('login-btn'),
                        adminLoginLink: document.getElementById('admin-login-link'),
                        
                        // Admin
                        adminPanel: document.getElementById('admin-panel'),
                        adminSearch: document.getElementById('admin-search'),
                        userList: document.getElementById('user-list'),
                        wineryList: document.getElementById('winery-list'),
                        addUserBtn: document.getElementById('add-user-btn'),
                        addWineryBtn: document.getElementById('add-winery-btn'),
                        adminLogoutBtn: document.getElementById('admin-logout-btn'),
                        
                        // Winery selection
                        wineryGrid: document.getElementById('winery-grid'),
                        wineryCardsContainer: document.getElementById('winery-cards-container'),
                        addWineryUserBtn: document.getElementById('add-winery-user-btn'),
                        
                        // Dashboard
                        dashboard: document.getElementById('dashboard'),
                        currentWineryName: document.getElementById('current-winery-name'),
                        varietySelect: document.getElementById('variety-select'),
                        parametersGrid: document.getElementById('parameters-grid'),
                        warningBox: document.getElementById('warning-box'),
                        warningMessage: document.getElementById('warning-message'),
                        backToWineriesBtn: document.getElementById('back-to-wineries-btn'),
                        liveCameraBtn: document.getElementById('live-camera-btn'),
                        openChatBtn: document.getElementById('open-chat-btn'),
                        
                        // Chart
                        harvestChart: document.getElementById('harvest-chart'),
                        timeframeBtns: document.querySelectorAll('.timeframe-btn'),
                        
                        // Chat
                        chatBox: document.getElementById('chat-box'),
                        chatMessages: document.getElementById('chat-messages'),
                        chatInput: document.getElementById('chat-input'),
                        sendBtn: document.getElementById('send-btn'),
                        chatToggleBtn: document.getElementById('chat-toggle-btn'),
                        
                        // Modals
                        cameraModal: document.getElementById('camera-modal'),
                        closeCameraModal: document.getElementById('close-camera-modal'),
                        refreshCameraBtn: document.getElementById('refresh-camera-btn'),
                        
                        addWineryModal: document.getElementById('add-winery-modal'),
                        closeAddWineryModal: document.getElementById('close-add-winery-modal'),
                        wineryCodeInput: document.getElementById('winery-code'),
                        confirmAddWinery: document.getElementById('confirm-add-winery'),
                        cancelAddWinery: document.getElementById('cancel-add-winery'),
                        
                        confirmModal: document.getElementById('confirm-modal'),
                        confirmTitle: document.getElementById('confirm-title'),
                        confirmMessage: document.getElementById('confirm-message'),
                        confirmAction: document.getElementById('confirm-action'),
                        cancelAction: document.getElementById('cancel-action'),
                        closeConfirmModal: document.getElementById('close-confirm-modal'),
                        
                        // Theme
                        themeToggle: document.getElementById('theme-toggle')
                    };
                },

                // Legare evenimente
                bindEvents() {
                    // Login
                    this.elements.loginBtn.addEventListener('click', () => this.handleLogin());
                    this.elements.adminLoginLink.addEventListener('click', () => this.toggleAdminLogin(true));
                    this.elements.passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleLogin();
                    });
                    
                    // Admin
                    this.elements.adminLogoutBtn.addEventListener('click', () => this.handleLogout());
                    this.elements.addUserBtn.addEventListener('click', () => this.showAddUserModal());
                    this.elements.addWineryBtn.addEventListener('click', () => this.showAddWineryModal(true));
                    this.elements.adminSearch.addEventListener('input', () => this.filterAdminItems());
                    
                    // Winery selection
                    this.elements.addWineryUserBtn.addEventListener('click', () => this.showAddWineryModal(false));
                    
                    // Dashboard
                    this.elements.backToWineriesBtn.addEventListener('click', () => this.showWinerySelection());
                    this.elements.liveCameraBtn.addEventListener('click', () => this.showCameraModal());
                    this.elements.openChatBtn.addEventListener('click', () => this.toggleChat(true));
                    this.elements.varietySelect.addEventListener('change', () => this.updateParameters());
                    
                    // Chart timeframe
                    this.elements.timeframeBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            this.elements.timeframeBtns.forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            this.updateChart(parseInt(btn.dataset.timeframe));
                        });
                    });
                    
                    // Chat
                    this.elements.chatToggleBtn.addEventListener('click', () => this.toggleChat());
                    this.elements.sendBtn.addEventListener('click', () => this.handleSendMessage());
                    this.elements.chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleSendMessage();
                    });
                    
                    // Modals
                    this.elements.closeCameraModal.addEventListener('click', () => this.hideModal('camera-modal'));
                    this.elements.refreshCameraBtn.addEventListener('click', () => this.refreshCamera());
                    
                    this.elements.closeAddWineryModal.addEventListener('click', () => this.hideModal('add-winery-modal'));
                    this.elements.confirmAddWinery.addEventListener('click', () => this.handleAddWinery());
                    this.elements.cancelAddWinery.addEventListener('click', () => this.hideModal('add-winery-modal'));
                    
                    this.elements.confirmAction.addEventListener('click', () => this.executeConfirmedAction());
                    this.elements.cancelAction.addEventListener('click', () => this.hideModal('confirm-modal'));
                    this.elements.closeConfirmModal.addEventListener('click', () => this.hideModal('confirm-modal'));
                    
                    // Theme toggle
                    this.elements.themeToggle.addEventListener('click', () => this.toggleDarkMode());
                },

                // Funcții pentru autentificare
                handleLogin() {
                    const username = this.elements.usernameInput.value.trim();
                    const password = this.elements.passwordInput.value.trim();
                    
                    if (!username || !password) {
                        this.showAlert('Introduceți username și parolă');
                        return;
                    }
                    
                    if (this.isAdmin) {
                        if (username === this.admin.username && password === this.admin.password) {
                            this.currentUser = { username: 'Administrator' };
                            this.showAdminPanel();
                        } else {
                            this.showAlert('Credențiale admin incorecte');
                        }
                    } else {
                        const user = this.users.find(u => u.username === username && u.password === password);
                        if (user) {
                            this.currentUser = user;
                            this.showWinerySelection();
                        } else {
                            this.showAlert('Username sau parolă incorectă');
                        }
                    }
                },

                toggleAdminLogin(isAdmin) {
                    this.isAdmin = isAdmin;
                    this.elements.adminLoginLink.textContent = isAdmin ? 
                        'Autentificare utilizator' : 
                        'Acces administrator';
                },

                handleLogout() {
                    this.currentUser = null;
                    this.isAdmin = false;
                    this.showLogin();
                },

                // Funcții pentru afișare conținut
                showLogin() {
                    this.hideAllSections();
                    this.elements.loginContainer.style.display = 'block';
                    this.elements.usernameInput.value = '';
                    this.elements.passwordInput.value = '';
                    this.elements.usernameInput.focus();
                },

                showAdminPanel() {
                    this.hideAllSections();
                    this.elements.adminPanel.style.display = 'block';
                    this.renderAdminUserList();
                    this.renderAdminWineryList();
                },

                showWinerySelection() {
                    this.hideAllSections();
                    this.elements.wineryGrid.style.display = 'grid';
                    this.renderWineryCards();
                },

                showDashboard(winery) {
                    this.hideAllSections();
                    this.currentWinery = winery;
                    this.elements.dashboard.style.display = 'block';
                    this.elements.currentWineryName.textContent = winery.name;
                    
                    // Populează selectorul de soiuri
                    this.elements.varietySelect.innerHTML = '';
                    winery.varieties.forEach(variety => {
                        const option = document.createElement('option');
                        option.value = variety;
                        option.textContent = variety;
                        this.elements.varietySelect.appendChild(option);
                    });
                    
                    this.updateParameters();
                    this.initChart();
                },

                hideAllSections() {
                    this.elements.loginContainer.style.display = 'none';
                    this.elements.adminPanel.style.display = 'none';
                    this.elements.wineryGrid.style.display = 'none';
                    this.elements.dashboard.style.display = 'none';
                },

                // Funcții pentru randare conținut
                renderWineryCards() {
                    this.elements.wineryCardsContainer.innerHTML = '';
                    
                    if (!this.currentUser) return;
                    
                    this.currentUser.wineries.forEach(wineryId => {
                        const winery = this.wineries.find(w => w.id === wineryId);
                        if (!winery) return;
                        
                        const card = document.createElement('div');
                        card.className = 'winery-card';
                        card.innerHTML = `
                            <div class="winery-card-header">
                                <div class="winery-card-name">${winery.name}</div>
                                <div class="winery-card-code">${winery.code}</div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <div><strong>Locație:</strong> ${winery.location}</div>
                                <div><strong>Suprafață:</strong> ${winery.area} ha</div>
                                <div><strong>Soiuri:</strong> ${winery.varieties.join(', ')}</div>
                            </div>
                        `;
                        
                        card.addEventListener('click', () => this.showDashboard(winery));
                        this.elements.wineryCardsContainer.appendChild(card);
                    });
                },

                renderAdminUserList() {
                    this.elements.userList.innerHTML = '';
                    
                    this.users.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <div>${user.username}</div>
                            <div class="admin-actions">
                                <button class="admin-btn edit-btn" data-id="${user.id}">Edit</button>
                                <button class="admin-btn delete-btn" data-id="${user.id}">Delete</button>
                            </div>
                        `;
                        
                        userItem.querySelector('.edit-btn').addEventListener('click', (e) => {
                            this.showEditUserModal(parseInt(e.target.dataset.id));
                        });
                        
                        userItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                            this.showConfirmModal(
                                'Ștergere utilizator',
                                `Sigur doriți să ștergeți utilizatorul ${user.username}?`,
                                () => this.deleteUser(parseInt(e.target.dataset.id))
                        });
                        
                        this.elements.userList.appendChild(userItem);
                    });
                },

                renderAdminWineryList() {
                    this.elements.wineryList.innerHTML = '';
                    
                    this.wineries.forEach(winery => {
                        const wineryItem = document.createElement('div');
                        wineryItem.className = 'winery-item';
                        wineryItem.innerHTML = `
                            <div>${winery.name} (${winery.code})</div>
                            <div class="admin-actions">
                                <button class="admin-btn edit-btn" data-id="${winery.id}">Edit</button>
                                <button class="admin-btn delete-btn" data-id="${winery.id}">Delete</button>
                            </div>
                        `;
                        
                        wineryItem.querySelector('.edit-btn').addEventListener('click', (e) => {
                            this.showEditWineryModal(parseInt(e.target.dataset.id));
                        });
                        
                        wineryItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                            this.showConfirmModal(
                                'Ștergere recoltă',
                                `Sigur doriți să ștergeți recolta ${winery.name}?`,
                                () => this.deleteWinery(parseInt(e.target.dataset.id))
                        });
                        
                        this.elements.wineryList.appendChild(wineryItem);
                    });
                },

                // Funcții pentru parametri și grafic
                updateParameters() {
                    if (!this.currentWinery) return;
                    
                    const variety = this.elements.varietySelect.value;
                    const data = this.currentWinery.data;
                    
                    this.elements.parametersGrid.innerHTML = `
                        <div class="parameter-card">
                            <div class="parameter-card-header">
                                <div class="parameter-name">Zahăr <div class="parameter-status"></div></div>
                            </div>
                            <div class="parameter-value">${data.sugar}</div>
                            <div class="parameter-unit">°Brix</div>
                            <div class="parameter-range">Interval optim: <span>22-25</span></div>
                        </div>
                        <div class="parameter-card">
                            <div class="parameter-card-header">
                                <div class="parameter-name">Aciditate <div class="parameter-status"></div></div>
                            </div>
                            <div class="parameter-value">${data.acidity}</div>
                            <div class="parameter-unit">g/L</div>
                            <div class="parameter-range">Interval optim: <span>5.5-7.5</span></div>
                        </div>
                        <div class="parameter-card">
                            <div class="parameter-card-header">
                                <div class="parameter-name">pH <div class="parameter-status"></div></div>
                            </div>
                            <div class="parameter-value">${data.ph}</div>
                            <div class="parameter-range">Interval optim: <span>3.2-3.8</span></div>
                        </div>
                        <div class="parameter-card">
                            <div class="parameter-card-header">
                                <div class="parameter-name">Temperatură <div class="parameter-status"></div></div>
                            </div>
                            <div class="parameter-value">${data.temperature}</div>
                            <div class="parameter-unit">°C</div>
                            <div class="parameter-range">Interval optim: <span>18-30</span></div>
                        </div>
                        <div class="parameter-card">
                            <div class="parameter-card-header">
                                <div class="parameter-name">Umiditate <div class="parameter-status"></div></div>
                            </div>
                            <div class="parameter-value">${data.humidity}</div>
                            <div class="parameter-unit">%</div>
                            <div class="parameter-range">Interval optim: <span>40-80</span></div>
                        </div>
                        <div class="parameter-card">
                            <div class="parameter-card-header">
                                <div class="parameter-name">Starea solului <div class="parameter-status"></div></div>
                            </div>
                            <div class="parameter-value">${data.soil}</div>
                        </div>
                    `;
                    
                    // Verifică parametrii și afișează avertismente
                    let warnings = [];
                    
                    if (parseFloat(data.sugar) < 22 || parseFloat(data.sugar) > 25) {
                        warnings.push(`Nivelul de zahăr (${data.sugar}°Brix) este ${parseFloat(data.sugar) < 22 ? 'sub' : 'peste'} optim pentru soiul ${variety}.`);
                    }
                    
                    if (parseFloat(data.acidity) < 5.5 || parseFloat(data.acidity) > 7.5) {
                        warnings.push(`Aciditatea (${data.acidity}g/L) este ${parseFloat(data.acidity) < 5.5 ? 'sub' : 'peste'} optimă pentru soiul ${variety}.`);
                    }
                    
                    if (parseFloat(data.ph) < 3.2 || parseFloat(data.ph) > 3.8) {
                        warnings.push(`Nivelul pH (${data.ph}) este ${parseFloat(data.ph) < 3.2 ? 'sub' : 'peste'} optim pentru soiul ${variety}.`);
                    }
                    
                    if (parseFloat(data.temperature) < 18 || parseFloat(data.temperature) > 30) {
                        warnings.push(`Temperatura (${data.temperature}°C) este ${parseFloat(data.temperature) < 18 ? 'sub' : 'peste'} optimă pentru soiul ${variety}.`);
                    }
                    
                    if (parseFloat(data.humidity) < 40 || parseFloat(data.humidity) > 80) {
                        warnings.push(`Umiditatea (${data.humidity}%) este ${parseFloat(data.humidity) < 40 ? 'sub' : 'peste'} optimă pentru soiul ${variety}.`);
                    }
                    
                    if (data.soil === "Umed") {
                        warnings.push(`Solul este prea umed pentru soiul ${variety}.`);
                    }
                    
                    if (warnings.length > 0) {
                        this.elements.warningMessage.innerHTML = warnings.map(w => `<p>${w}</p>`).join('');
                        this.elements.warningBox.style.display = 'block';
                    } else {
                        this.elements.warningBox.style.display = 'none';
                    }
                },

                initChart() {
                    if (this.chart) {
                        this.chart.destroy();
                    }
                    
                    const ctx = this.elements.harvestChart.getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: this.generateChartData(7),
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    });
                },

                updateChart(timeframe = 7) {
                    if (!this.chart) return;
                    
                    this.chart.data = this.generateChartData(timeframe);
                    this.chart.update();
                },

                generateChartData(timeframe) {
                    const labels = [];
                    const today = new Date();
                    
                    for (let i = timeframe; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString('ro-RO'));
                    }
                    
                    return {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Zahăr (°Brix)',
                                data: this.generateRandomData(22, 25, timeframe),
                                borderColor: '#5E2B7A',
                                backgroundColor: 'rgba(94, 43, 122, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Aciditate (g/L)',
                                data: this.generateRandomData(5.5, 7.5, timeframe),
                                borderColor: '#D4A76A',
                                backgroundColor: 'rgba(212, 167, 106, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'pH',
                                data: this.generateRandomData(3.2, 3.8, timeframe),
                                borderColor: '#8BC34A',
                                backgroundColor: 'rgba(139, 195, 74, 0.1)',
                                tension: 0.4
                            }
                        ]
                    };
                },

                generateRandomData(min, max, count) {
                    const data = [];
                    for (let i = 0; i <= count; i++) {
                        data.push((Math.random() * (max - min) + min).toFixed(1));
                    }
                    return data;
                },

                // Funcții pentru chat
                toggleChat(show = null) {
                    if (show === null) {
                        show = this.elements.chatBox.style.display !== 'flex';
                    }
                    
                    this.elements.chatBox.style.display = show ? 'flex' : 'none';
                    
                    if (show) {
                        this.elements.chatInput.focus();
                    }
                },

                handleSendMessage() {
                    const message = this.elements.chatInput.value.trim();
                    if (!message) return;
                    
                    this.addChatMessage(message, 'user');
                    this.elements.chatInput.value = '';
                    
                    // Simulează răspunsul AI
                    setTimeout(() => {
                        const aiResponse = this.generateAIResponse(message);
                        this.addChatMessage(aiResponse, 'ai');
                    }, 500);
                },

                addChatMessage(message, sender) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${sender}-message`;
                    messageDiv.textContent = message;
                    this.elements.chatMessages.appendChild(messageDiv);
                    
                    // Salvează în istoric
                    this.chatHistory.push({
                        sender: sender,
                        message: message,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Scroll la ultimul mesaj
                    this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                },

                generateAIResponse(message) {
                    const lowerMessage = message.toLowerCase();
                    
                    if (lowerMessage.includes('zahăr') || lowerMessage.includes('zahar')) {
                        return `Nivelul curent de zahăr este ${this.currentWinery.data.sugar}°Brix. Intervalul optim este între 22-25°Brix.`;
                    }
                    
                    if (lowerMessage.includes('aciditate') || lowerMessage.includes('acid')) {
                        return `Aciditatea curentă este ${this.currentWinery.data.acidity}g/L. Intervalul optim este între 5.5-7.5g/L.`;
                    }
                    
                    if (lowerMessage.includes('ph')) {
                        return `Nivelul curent de pH este ${this.currentWinery.data.ph}. Intervalul optim este între 3.2-3.8.`;
                    }
                    
                    if (lowerMessage.includes('temperatur') || lowerMessage.includes('temp')) {
                        return `Temperatura curentă este ${this.currentWinery.data.temperature}°C. Intervalul optim este între 18-30°C.`;
                    }
                    
                    if (lowerMessage.includes('umiditate') || lowerMessage.includes('umid')) {
                        return `Umiditatea curentă este ${this.currentWinery.data.humidity}%. Intervalul optim este între 40-80%.`;
                    }
                    
                    if (lowerMessage.includes('sol') || lowerMessage.includes('pământ') || lowerMessage.includes('pamant')) {
                        return `Starea curentă a solului este ${this.currentWinery.data.soil === 'Optim' ? 'optimă' : 'prea umedă'}.`;
                    }
                    
                    if (lowerMessage.includes('salut') || lowerMessage.includes('bună') || lowerMessage.includes('buna')) {
                        return 'Bună ziua! Cu ce vă pot ajuta astăzi?';
                    }
                    
                    if (lowerMessage.includes('ajutor') || lowerMessage.includes('ajut')) {
                        return 'Pot să vă ajut cu informații despre:\n- Parametrii recoltei (zahăr, aciditate, pH)\n- Condiții de mediu (temperatură, umiditate)\n- Starea solului\n- Recomandări pentru îngrijirea viței de vie';
                    }
                    
                    return 'Înțeleg că doriți informații despre vița de vie. Pentru ajutor mai precis, puteți întreba despre:\n- Parametrii recoltei\n- Condiții de mediu\n- Recomandări de îngrijire';
                },

                // Funcții pentru modale
                showCameraModal() {
                    this.showModal('camera-modal');
                },

                showAddWineryModal(isAdmin) {
                    this.isAdminAddWinery = isAdmin;
                    this.elements.wineryCodeInput.value = '';
                    this.showModal('add-winery-modal');
                },

                showEditUserModal(userId) {
                    // Implementare editare utilizator
                    this.showAlert('Funcționalitatea de editare utilizator va fi implementată în versiunea următoare');
                },

                showEditWineryModal(wineryId) {
                    // Implementare editare recoltă
                    this.showAlert('Funcționalitatea de editare recoltă va fi implementată în versiunea următoare');
                },

                showConfirmModal(title, message, callback) {
                    this.elements.confirmTitle.textContent = title;
                    this.elements.confirmMessage.textContent = message;
                    this.confirmCallback = callback;
                    this.showModal('confirm-modal');
                },

                showModal(modalId) {
                    document.getElementById(modalId).style.display = 'flex';
                },

                hideModal(modalId) {
                    document.getElementById(modalId).style.display = 'none';
                },

                executeConfirmedAction() {
                    if (this.confirmCallback) {
                        this.confirmCallback();
                    }
                    this.hideModal('confirm-modal');
                },

                // Funcții pentru acțiuni
                handleAddWinery() {
                    const code = this.elements.wineryCodeInput.value.trim();
                    
                    if (!code) {
                        this.showAlert('Introduceți codul recoltă');
                        return;
                    }
                    
                    if (this.isAdminAddWinery) {
                        // Adăugare recoltă nouă în sistem
                        const newWinery = {
                            id: Math.max(...this.wineries.map(w => w.id)) + 1,
                            code: code,
                            name: `Recolta ${code}`,
                            location: 'Nouă locație',
                            area: 1.0,
                            varieties: ['Soi nou'],
                            data: {
                                sugar: '22.0',
                                acidity: '6.0',
                                ph: '3.5',
                                temperature: '22.0',
                                humidity: '60',
                                soil: 'Optim'
                            }
                        };
                        
                        this.wineries.push(newWinery);
                        this.saveToLocalStorage();
                        this.showAlert(`Recolta ${code} a fost adăugată în sistem`);
                    } else {
                        // Asociere recoltă existentă cu utilizatorul
                        const winery = this.wineries.find(w => w.code === code);
                        
                        if (!winery) {
                            this.showAlert('Cod recoltă invalid');
                            return;
                        }
                        
                        if (this.currentUser.wineries.includes(winery.id)) {
                            this.showAlert('Această recoltă este deja asociată contului dumneavoastră');
                            return;
                        }
                        
                        this.currentUser.wineries.push(winery.id);
                        this.saveToLocalStorage();
                        this.showAlert(`Recolta ${winery.name} a fost asociată contului dumneavoastră`);
                    }
                    
                    this.hideModal('add-winery-modal');
                    this.renderWineryCards();
                },

                deleteUser(userId) {
                    this.users = this.users.filter(u => u.id !== userId);
                    this.saveToLocalStorage();
                    this.renderAdminUserList();
                    this.showAlert('Utilizator șters cu succes');
                },

                deleteWinery(wineryId) {
                    // Elimină recolta din lista principală
                    this.wineries = this.wineries.filter(w => w.id !== wineryId);
                    
                    // Elimină recolta din listele utilizatorilor
                    this.users.forEach(user => {
                        user.wineries = user.wineries.filter(id => id !== wineryId);
                    });
                    
                    this.saveToLocalStorage();
                    this.renderAdminWineryList();
                    this.showAlert('Recoltă ștearsă cu succes');
                },

                refreshCamera() {
                    // Simulare reîmprospătare imagine cameră
                    this.showAlert('Imaginea camerei a fost actualizată');
                },

                filterAdminItems() {
                    const searchTerm = this.elements.adminSearch.value.toLowerCase();
                    
                    // Filtrare utilizatori
                    document.querySelectorAll('.user-item').forEach(item => {
                        const username = item.querySelector('div').textContent.toLowerCase();
                        item.style.display = username.includes(searchTerm) ? 'flex' : 'none';
                    });
                    
                    // Filtrare recolte
                    document.querySelectorAll('.winery-item').forEach(item => {
                        const wineryText = item.querySelector('div').textContent.toLowerCase();
                        item.style.display = wineryText.includes(searchTerm) ? 'flex' : 'none';
                    });
                },

                // Funcții pentru tema întunecată
                checkDarkMode() {
                    const isDark = localStorage.getItem('darkMode') === 'true';
                    if (isDark) {
                        document.body.classList.add('dark-mode');
                        this.updateThemeIcon(true);
                    }
                },

                toggleDarkMode() {
                    const isDark = document.body.classList.toggle('dark-mode');
                    localStorage.setItem('darkMode', isDark);
                    this.updateThemeIcon(isDark);
                },

                updateThemeIcon(isDark) {
                    this.elements.themeToggle.innerHTML = isDark ?
                        `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>` :
                        `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                        </svg>`;
                },

                // Funcții utilitare
                showAlert(message) {
                    alert(message);
                }
            };

            // Inițializare aplicație
            app.init();
        });
    </script>
</body>
</html>
